<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>×©××©/×¦×œ ×œ××¦×•×§×™× ×‘×§×¤×¨×™×¡×™×Ÿ</title>
  <!-- Social / Share Preview Meta -->
  <meta name="description" content="Cyprus crags shade calculator â€“ find sun and shade times for climbing sectors." />
  <meta property="og:title" content="Cyprus Crags Shade Calculator" />
  <meta property="og:description" content="Find when each Cyprus climbing crag is in sun or shade throughout the day." />
  <meta property="og:type" content="website" />
  <!-- Optionally set your canonical URL below -->
  <!-- <meta property=\"og:url\" content=\"https://your-domain.example/\" /> -->
  <meta property="og:site_name" content="Cyprus Crags Shade Calculator" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Cyprus Crags Shade Calculator" />
  <meta name="twitter:description" content="Find when each Cyprus climbing crag is in sun or shade throughout the day." />

  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" defer></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f7fafc;--card:#ffffff;--text:#1f2937;--muted:#6b7280;--border:#e5e7eb}
    *{box-sizing:border-box}
    html,body{height:100dvh}
    body{
      margin:0;background:url('1.jpg') center center / cover no-repeat fixed; color:var(--text);
      font-family:'Inter', system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      display:flex;flex-direction:column;align-items:stretch;padding:0;overflow:hidden;
    }
  .app{width:75%;max-width:1200px;height:calc(100dvh - var(--headerH, 0px));display:grid;grid-template-rows:auto 1fr auto;gap:8px;margin:8px auto;padding:0 10px;min-height:0}
    .card{background:#ffffff;border:1px solid rgba(229,231,235,0.7);border-radius:0;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    .topbar{display:flex;align-items:center;justify-content:space-between}
    .site-topbar{position:sticky;top:0;z-index:20;width:100%;border-left:none;border-right:none;background:#ffffff}
  .topbar .nav-btn{border:none;background:transparent;padding:10px 16px;height:40px;display:inline-flex;align-items:center;justify-content:center;border-bottom:2px solid transparent;gap:8px}
    .topbar .nav-btn:hover{border-bottom-color:#cbd5e1}
    .topbar .nav-btn.active{border-bottom-color:#2f8cff}
    .lang-btn{border:none;background:transparent;padding:10px 16px;height:40px;display:inline-flex;align-items:center;justify-content:center}
    .lang-menu .lang-item{padding:8px 10px;display:flex;gap:8px;align-items:center;cursor:pointer}
    .lang-menu .lang-item:hover{background:#f3f4f6}
    .brand{display:flex;gap:14px;align-items:center;justify-content:center;margin-bottom:10px}
    .brand .flag{font-size:64px;filter:saturate(1.1)}
    .brand .titles{display:flex;flex-direction:column;gap:4px;align-items:center;text-align:center}
  .brand .title{margin:0;font-size:28px;line-height:1.2;letter-spacing:.2px}
    .brand .subtitle{margin:0;color:var(--muted);font-size:13px}
    .controls{display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:end}
  label{display:block;font-size:11px;color:var(--muted);margin-bottom:4px;letter-spacing:.15px;text-transform:uppercase}
  select,input,button,textarea{width:100%;padding:8px 10px;border-radius:0;border:1px solid rgba(229,231,235,0.8);background:#ffffff;color:var(--text);font-size:14px}
    select{appearance:none;background-image:linear-gradient(45deg,transparent 50%,#2f8cff 50%),linear-gradient(135deg,#2f8cff 50%,transparent 50%),linear-gradient(to right,#ffffff,#ffffff);background-position:calc(100% - 18px) calc(50% - 3px),calc(100% - 12px) calc(50% - 3px),calc(100% - 36px) 0;background-size:6px 6px,6px 6px,1px 100%;background-repeat:no-repeat}
    select:focus,input:focus,textarea:focus{outline:none;border-color:#93c5fd;box-shadow:0 0 0 2px rgba(147,197,253,.35)}
    button{background:linear-gradient(135deg,#2f8cff,#7cc8ff);border:none;color:#07101a;font-weight:700;cursor:pointer}
    button:active{transform:scale(.98)}
    .meta{display:flex;gap:10px;flex-wrap:wrap;font-size:13px;color:var(--muted)}
    .pill{background:#f3f4f6;border:1px solid rgba(229,231,235,0.8);color:#374151;padding:6px 10px;border-radius:0}
  .chart-wrap{height:100%;display:flex;flex-direction:column;min-height:0}
  .canvas-box{flex:1;min-height:0;max-height:none}
    canvas{width:100% !important;height:100% !important;background:transparent;border:none;border-radius:0;padding:0}
  #sectorTabs{display:flex;gap:4px;flex-wrap:nowrap;margin-bottom:8px;overflow:hidden;border-bottom:1px solid rgba(229,231,235,0.8);padding-bottom:4px}
  #sectorTabs.two-lines{flex-wrap:wrap;overflow:visible}
  /* Per-crag tint via CSS var set in JS */
  #sectorTabs{ --h: 210; --tint: hsl(var(--h) 100% 96% / 0.9); --line: hsl(var(--h) 85% 42%); background: var(--tint); padding:6px 8px; border-radius:0 }
  #sectorTabs .tab{border:none;background:transparent;padding:6px 8px;cursor:pointer;border-bottom:2px solid transparent;color:#374151;flex:1 1 0;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:12px}
  #sectorTabs.two-lines .tab{flex:1 1 calc(50% - 6px);white-space:nowrap}
  /* West Pentadaktylos specific grid: 2 rows, 6 columns */
  #sectorTabs.west-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:4px;overflow:hidden}
  #sectorTabs.west-grid .tab{width:100%;flex:initial;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  @media (min-width:700px){ #sectorTabs .tab{font-size:13px;padding:7px 9px} }
  #sectorTabs .tab:hover{border-bottom-color:var(--line);color:#111827}
  #sectorTabs .tab.active{border-bottom-color:var(--line);color:#111827;font-weight:600}
    .foot{font-size:12px;color:var(--muted)}
    .credit{margin-top:6px}
  /* Emphasize summary line */
  #summary{font-size:14px;color:#000000;font-weight:700;background:linear-gradient(0deg, #fff7cc, #fff7cc);border:1px solid #fde68a;padding:10px 12px}
    .feedback-title{margin:0 0 8px 0;font-size:16px}
    .feedback-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
    .feedback-grid textarea{grid-column:1 / -1;min-height:90px;resize:vertical}
  @media (max-width:1024px){ .app{width:90%;} }
  @media (max-width:860px){ .app{width:100%;} .controls{grid-template-columns:1fr; grid-auto-rows:auto} }
  /* Hide big title block on phones so UI starts directly with crag selection */
  @media (max-width:640px){ .brand{display:none} }
  /* Mobile: show full Pentadaktylos West names (wrap allowed) */
  @media (max-width:640px){
    /* Multi ( >3 sectors ) crag: show dropdown instead of tabs */
    #sectorTabs.multi-grid{grid-template-columns:repeat(2,1fr);}
    #sectorTabs.multi-grid .tab{white-space:normal;overflow:visible;text-overflow:unset;font-size:13px;line-height:1.15;padding:8px 6px;}
    #sectorTabs.multi-grid.mobile-hidden{display:none}
    #mobileCragSelectWrap{display:block}
  }
  @media (min-width:641px){
    #mobileCragSelectWrap{display:none}
  }
  </style>
</head>
<body>
  <header class="card topbar site-topbar">
    <nav style="display:flex;gap:12px;align-items:center">
      <button id="navCalc" class="nav-btn active" data-view="calc"><span class="icon" aria-hidden="true" style="display:inline-flex;align-items:center;justify-content:center">
        <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
          <defs>
            <linearGradient id="sunShadeSplit" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#FFD94D"/>
              <stop offset="50%" stop-color="#FFD94D"/>
              <stop offset="50%" stop-color="#4B5563"/>
              <stop offset="100%" stop-color="#1F2937"/>
            </linearGradient>
          </defs>
          <!-- Sun circle split half bright half shade -->
          <circle cx="12" cy="12" r="6" fill="url(#sunShadeSplit)" stroke="#874400" stroke-width="0.6" />
          <!-- Rays only on bright half -->
          <g stroke="#F59E0B" stroke-linecap="round" stroke-width="1.4">
            <line x1="12" y1="2.5" x2="12" y2="5" />
            <line x1="7.05" y1="4.05" x2="8.8" y2="5.8" />
            <line x1="4.5" y1="9.5" x2="7" y2="9.5" />
            <line x1="7.05" y1="19.95" x2="8.85" y2="18.2" />
            <line x1="12" y1="19" x2="12" y2="21.5" />
          </g>
        </svg>
      </span><span class="label">Calculator</span></button>
      <button id="navFeedback" class="nav-btn" data-view="feedback"><span class="icon" aria-hidden="true">âœ‰ï¸</span><span class="label">Feedback</span></button>
    </nav>
    <div class="lang-switch" style="position:relative;display:flex;align-items:center;gap:8px">
      <button id="langBtn" aria-haspopup="listbox" aria-expanded="false" class="lang-btn" style="display:flex;align-items:center;gap:8px">
        <span id="langIcon">ğŸŒ</span>
        <span id="langName">English</span>
      </button>
      <div id="langMenu" role="listbox" class="lang-menu" style="display:none;position:absolute;top:36px;right:0;background:#fff;border:1px solid var(--border);box-shadow:0 8px 24px rgba(0,0,0,.06);min-width:160px;z-index:10">
        <div class="lang-item" data-lang="en" role="option">ğŸ‡¬ğŸ‡§ English</div>
        <div class="lang-item" data-lang="el" role="option">ğŸ‡¬ğŸ‡· Î•Î»Î»Î·Î½Î¹ÎºÎ¬</div>
        <div class="lang-item" data-lang="ru" role="option">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</div>
        <div class="lang-item" data-lang="he" role="option">ğŸ‡®ğŸ‡± ×¢×‘×¨×™×ª</div>
      </div>
    </div>
  </header>
  <div class="app">
    <div class="card" id="calcView">
      <div class="brand">
        <div class="flag" aria-hidden="true">ğŸ‡¨ğŸ‡¾</div>
        <div class="titles">
          <h1 class="title">Sun/Shade for Cyprus Crags</h1>
          <div class="subtitle">A handy tool for climbers</div>
        </div>
      </div>
      <div class="controls">
        <div>
          <label for="sectorSel" id="label-sector">Sector</label>
          <select id="sectorSel"></select>
        </div>
        <div>
          <label for="dateInp" id="label-date">Date</label>
          <input id="dateInp" type="date" />
        </div>
      </div>
  <!-- Removed loaded-sectors status line per request -->
    </div>

    <div class="card chart-wrap">
      <div id="sectorTabs"></div>
      <div id="mobileCragSelectWrap" style="display:none;margin:4px 0 8px 0">
        <select id="mobileCragSelect" style="width:100%;padding:6px 8px;font-size:13px"></select>
      </div>
      <div class="meta" id="meta" style="display:none"></div>
      <div class="canvas-box"><canvas id="chart"></canvas></div>
      <div id="summary" class="foot" style="margin-top:8px"></div>
    </div>

    <div class="card" id="feedbackView" style="display:none">
      <h3 class="feedback-title" id="fb-title">Send message / feedback</h3>
      <div class="feedback-grid">
        <div>
          <label for="fbName" id="fb-label-name">Name</label>
          <input id="fbName" type="text" placeholder="" />
        </div>
        <div>
          <label for="fbEmail" id="fb-label-email">Email</label>
          <input id="fbEmail" type="email" placeholder="" />
        </div>
        <div style="grid-column:1/-1">
          <label for="fbMsg" id="fb-label-msg">Message</label>
          <textarea id="fbMsg" placeholder=""></textarea>
        </div>
      </div>
      <button id="fbSendBtn">Send</button>
      <div class="foot" id="fbStatus" style="margin-top:6px"></div>
    </div>

    <div class="card foot">
      <div class="credit" id="creditLine">Built for climbers in Cyprus ğŸ‡¨ğŸ‡¾ Â· Credit: <b>Yehonatan Cohen</b> Â· <a id="creditEmail" href="mailto:unique.center.yoni.gmail.com">unique.center.yoni.gmail.com</a> Â· Â© 2025</div>
    </div>
  </div>

  <script>
    /***************
     * ×¡×§×˜×•×¨×™× ×›×¦×œ×¢ (edge)
     * face_side: "right" = ×—×–×™×ª ×œ×™××™×Ÿ ×”×›×™×•×•×Ÿ p1->p2, "left" = ×œ×©×××œ.
     * tilt_from_vertical_deg: 0=× ×™×¦×‘, +×©×œ×™×œ×™ (Overhang), -×—×™×•×‘×™ (Slab).
     * horizon_alt_deg: ×’×•×‘×” ××•×¤×§ ××—×™×“ (Â°).
     *
     * obstacles â€“ ×›×¢×ª × ×›×ª×‘×™× ×™×—×¡×™×ª ×œ××¤× ×” (aspect) ×©×œ ×”×¡×§×˜×•×¨:
     *   { az_from_deg, az_to_deg, alt_min_deg, note }
     *   ×”×˜×•×•×— ××•×’×“×¨ ××©×××œ (from) ×œ×™××™×Ÿ (to) ×¡×‘×™×‘ ×”-aspect.
     *   ×“×•×’×××•×ª: [-90..+90] = ×›×œ ×”×§×“×™××”; [0..+90] = ×™××™×Ÿ ×‘×œ×‘×“; [-90..0] = ×©×××œ ×‘×œ×‘×“.
     ***************/

    // Dynamic sectors source (loaded from sectors.json) with local-file fallback
    const DEFAULT_SECTORS = [
      {"id":"episkopi-main","name":"Î•piskopi-main","edge":{"p1":{"lat":34.79404109798569,"lon":32.526900902158296},"p2":{"lat":34.793816565875005,"lon":32.52695509277609}},"face_side":"left","tilt_from_vertical_deg":-25,"horizon_alt_deg":0,"obstacles":[{"az_from_deg":-90,"az_to_deg":90,"alt_min_deg":5,"note":"×¢×¦×™×"}],"min_alt_deg":3,"az_margin_deg":0},
      {"id":"Episkopi-face","name":"Î•piskopi-face","edge":{"p1":{"lat":34.7937292884894,"lon":32.52672671851574},"p2":{"lat":34.79375792308118,"lon":32.52685546454608}},"face_side":"right","tilt_from_vertical_deg":0,"horizon_alt_deg":1,"obstacles":[{"az_from_deg":230,"az_to_deg":260,"alt_min_deg":0,"note":"×¢×¦×™×"}],"min_alt_deg":3,"az_margin_deg":0},
      {"id":"gerakopetra main","name":"Gerakopetra main","edge":{"p1":{"lat":34.96540123799258,"lon":32.36986707840061},"p2":{"lat":34.965962781972244,"lon":32.37032526703459}},"face_side":"left","tilt_from_vertical_deg":0,"horizon_alt_deg":0,"obstacles":[{"az_from_deg":230,"az_to_deg":260,"alt_min_deg":0,"note":"×¢×¦×™×"}],"min_alt_deg":3,"az_margin_deg":0},
      {"id":"gerakopetra slab","name":"Gerakopetra slab","edge":{"p1":{"lat":34.965920959683054,"lon":32.370509929547794},"p2":{"lat":34.96574382108759,"lon":32.370879486717556}},"face_side":"left","tilt_from_vertical_deg":25,"horizon_alt_deg":0,"obstacles":[{"az_from_deg":0,"az_to_deg":0,"alt_min_deg":0,"note":"×¢×¦×™×"}],"min_alt_deg":3,"az_margin_deg":0},
      {"id":"alikou - main","name":"Alikou - main","edge":{"p1":{"lat":34.95708693692952,"lon":32.37886983471838},"p2":{"lat":34.95735094926628,"lon":32.37895296535831}},"face_side":"left","tilt_from_vertical_deg":0,"horizon_alt_deg":0,"obstacles":[{"az_from_deg":230,"az_to_deg":260,"alt_min_deg":0,"note":"×¢×¦×™×"}],"min_alt_deg":3,"az_margin_deg":0}
    ];
  let RAW_SECTORS = [];
  let SECTORS = [];
  let LOAD_USED_FALLBACK = false;
  let LOAD_COUNT = 0;
  // Grouping and selection state for crag -> sectors UI
  let GROUPS = []; // [{ key, label, indices:[sectorIndex,...] }]
  let CRAG_SEL_KEY = '';
  let CURRENT_SECTOR_INDEX = -1;
  async function loadSectors(){
    let usedFallback = false;
    try{
      const res = await fetch('sectors.json?ts=' + Date.now(), { cache: 'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      RAW_SECTORS = Array.isArray(data?.sectors) ? data.sectors : [];
      if(!RAW_SECTORS.length) throw new Error('Empty sectors');
    }catch(err){
      console.warn('Failed to load sectors.json, using defaults.', err);
      RAW_SECTORS = DEFAULT_SECTORS;
      usedFallback = true;
    }
    LOAD_USED_FALLBACK = usedFallback;
    SECTORS = RAW_SECTORS.map(s => {
      const mid = { lat:(s.edge.p1.lat+s.edge.p2.lat)/2, lon:(s.edge.p1.lon+s.edge.p2.lon)/2 };
      const aspect = aspectFromEdge(s.edge, s.face_side);
      return {
        id: s.id,
        name: s.name,
        lat: mid.lat,
        lon: mid.lon,
        aspect,
        tilt: (typeof s.tilt_from_vertical_deg === 'number') ? s.tilt_from_vertical_deg : 0,
        defaults: {
          minAlt: (typeof s.min_alt_deg === 'number') ? s.min_alt_deg : 3,
          margin: (typeof s.az_margin_deg === 'number') ? s.az_margin_deg : 0,
          horizon: (typeof s.horizon_alt_deg === 'number') ? s.horizon_alt_deg : 0
        },
        obstaclesAbs: mapObstaclesRelativeToAspect(s.obstacles || [], aspect),
        raw: s
      };
    });
    SECTORS.sort((a,b) => (a.name||'').localeCompare(b.name||'', undefined, {sensitivity:'base'}));
    LOAD_COUNT = SECTORS.length;
  }

    // ---------- ××ª××˜×™×§×” ----------
    const d2 = n => String(n).padStart(2,'0');
    const toRad = d => d*Math.PI/180;
    const toDeg = r => r*180/Math.PI;

    function bearingDeg(p1, p2){
      const Ï†1 = toRad(p1.lat), Ï†2 = toRad(p2.lat);
      const Î”Î» = toRad(p2.lon - p1.lon);
      const y = Math.sin(Î”Î») * Math.cos(Ï†2);
      const x = Math.cos(Ï†1)*Math.sin(Ï†2) - Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î”Î»);
      let Î¸ = toDeg(Math.atan2(y, x)); if (Î¸ < 0) Î¸ += 360; return Î¸;
    }
    function aspectFromEdge(edge, faceSide){
      const brg = bearingDeg(edge.p1, edge.p2);
      if (faceSide === 'right') return (brg + 90) % 360;
      if (faceSide === 'left')  return (brg + 270) % 360;
      throw new Error('face_side must be "right" or "left"');
    }
    function angleDiff(a,b){ let d=Math.abs(a-b)%360; return d>180? 360-d : d; }
    function azimuthDeg(pos){ return toDeg(pos.azimuth) + 180; } // SunCalc 0=×“×¨×•× â†’ ×××¤×™× ×œ-0=×¦×¤×•×Ÿ
    function altitudeDeg(pos){ return toDeg(pos.altitude); }

    // ×•×§×˜×•×¨ ×”×©××© ×-××–×™××•×˜/×’×•×‘×” (ENU)
    function sunVector(azDeg, altDeg){
      const az = toRad(azDeg), alt = toRad(altDeg);
      const e = Math.cos(alt)*Math.sin(az);
      const n = Math.cos(alt)*Math.cos(az);
      const u = Math.sin(alt);
      return {e,n,u};
    }
    // × ×•×¨××œ ×©×œ ×”××©×˜×— ××ª×•×š ×—×–×™×ª ×•-tilt ××”×× ×›×™
    function normalVector(aspectDeg, tiltFromVerticalDeg){
      const A = toRad(aspectDeg);
      const t = toRad(tiltFromVerticalDeg);
      const hmag = Math.cos(t);     // ×¨×›×™×‘ ××•×¤×§×™
      const u = Math.sin(t);        // ×¨×›×™×‘ ×× ×›×™ (+ ×œ××¢×œ×” ×‘×©×œ×™×œ×™) â€” ×œ× ××©× ×™× ×œ×¤×™ ×‘×§×©×ª×š
      const e = hmag * Math.sin(A);
      const n = hmag * Math.cos(A);
      return {e,n,u};
    }
    function dot3(a,b){ return a.e*b.e + a.n*b.n + a.u*b.u; }

    // ××•×¤×§/××›×©×•×œ×™×
    function norm360(x){ x = x % 360; return x<0 ? x+360 : x; }
    function azInRange(az, a1, a2){
      az = norm360(az); a1 = norm360(a1); a2 = norm360(a2);
      if (a1 <= a2) return az >= a1 && az <= a2;
      return az >= a1 || az <= a2; // ×˜×•×•×— ×©×—×•×¦×” 0Â°
    }
    // ××™×¤×•×™ ××›×©×•×œ×™× ×™×—×¡×™×™× (from=×©×××œ, to=×™××™×Ÿ) ×œ××•×—×œ×˜×™× ×¡×‘×™×‘ ×”-aspect
    function mapObstaclesRelativeToAspect(obstacles, aspect){
      return (obstacles || []).map(o => {
        const leftAbs  = norm360(aspect + (o.az_from_deg ?? 0));
        const rightAbs = norm360(aspect + (o.az_to_deg   ?? 0));
        return {
          az_from_deg: leftAbs,
          az_to_deg: rightAbs,
          alt_min_deg: (typeof o.alt_min_deg === 'number') ? o.alt_min_deg : 0,
          note: o.note || ''
        };
      });
    }
    function obstacleAltForAz(az, obstaclesAbs){
      let maxAlt = -Infinity;
      for(const o of (obstaclesAbs||[])){
        if(azInRange(az, o.az_from_deg, o.az_to_deg)){
          if(typeof o.alt_min_deg === 'number') maxAlt = Math.max(maxAlt, o.alt_min_deg);
        }
      }
      return (maxAlt === -Infinity) ? null : maxAlt;
    }

  // SECTORS will be populated by loadSectors()

    // ---------- UI ----------
    const sel = document.getElementById('sectorSel');
    const dateInp = document.getElementById('dateInp');
    const meta = document.getElementById('meta');
    const summary = document.getElementById('summary');
    const creditLine = document.getElementById('creditLine');
    const calcView = document.getElementById('calcView');
    const feedbackView = document.getElementById('feedbackView');
    const navCalc = document.getElementById('navCalc');
    const navFeedback = document.getElementById('navFeedback');
    const sectorTabs = document.getElementById('sectorTabs');
    const langBtn = document.getElementById('langBtn');
    const langMenu = document.getElementById('langMenu');
    const langIcon = document.getElementById('langIcon');
    const langName = document.getElementById('langName');

    // i18n
    const I18N = {
      en: {
        title: 'Sun/Shade for Cyprus Crags',
        subtitle: 'A handy tool for climbers',
  labels: { language: 'Language', sector: 'Crag', date: 'Date' },
        chartTitle: 'Sun exposure (%) over time',
        sun: 'Sun', shade: 'Shade',
        axes: { xTitle: 'Time', yTitle: 'Exposure' },
        nav: { calc: 'Calculator', feedback: 'Feedback' },
        credit: 'Built for climbers in Cyprus ğŸ‡¨ğŸ‡¾ Â· Credit: Yehonatan Cohen',
        meta: { sector:'Sector', aspect:'Aspect', tilt:'Tilt', baseHorizon:'Base horizon', obstacles:'Obstacles', date:'Date', minAlt:'Min sun alt', azMargin:'Azimuth margin' },
  obstaclesNone: 'No obstacles', obstaclesCount: n => `${n} obstacles`,
  segmentsSome: 'Sun times', segmentsNone: 'No sun in 06:00â€“20:00 window with current parameters.',
  fb: { title:'Send message / feedback', name:'Name', email:'Email', msg:'Message', send:'Send (a message, not a route) ğŸ™‚', thanks:'Thanks! Your email client should open. If not, copy the text and send manually.' }
      },
      el: {
        title: 'Î‰Î»Î¹Î¿Ï‚/Î£ÎºÎ¹Î¬ Î³Î¹Î± Î±Î½Î±ÏÏÎ¹Ï‡Î·Ï„Î¹ÎºÎ¬ Ï€ÎµÎ´Î¯Î± ÏƒÏ„Î·Î½ ÎšÏÏ€ÏÎ¿',
        subtitle: 'ÎˆÎ½Î± Ï‡ÏÎ®ÏƒÎ¹Î¼Î¿ ÎµÏÎ³Î±Î»ÎµÎ¯Î¿ Î³Î¹Î± Î±Î½Î±ÏÏÎ¹Ï‡Î·Ï„Î­Ï‚',
  labels: { language: 'Î“Î»ÏÏƒÏƒÎ±', sector: 'Î’ÏÎ¬Ï‡Î¿Ï‚', date: 'Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±' },
        chartTitle: 'Î Î¿ÏƒÎ¿ÏƒÏ„ÏŒ Î­ÎºÎ¸ÎµÏƒÎ·Ï‚ ÏƒÏ„Î¿Î½ Î®Î»Î¹Î¿ (%) ×œ××•×¨×š ×–××Ÿ',
        sun: 'Î‰Î»Î¹Î¿Ï‚', shade: 'Î£ÎºÎ¹Î¬',
        axes: { xTitle: 'ÎÏÎ±', yTitle: 'ÎˆÎºÎ¸ÎµÏƒÎ·' },
        nav: { calc: 'Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÏ„Î®Ï‚', feedback: 'Î£Ï‡ÏŒÎ»Î¹Î¿' },
        credit: 'Î¦Ï„Î¹Î±Î³Î¼Î­Î½Î¿ Î³Î¹Î± Î±Î½Î±ÏÏÎ¹Ï‡Î·Ï„Î­Ï‚ ÏƒÏ„Î·Î½ ÎšÏÏ€ÏÎ¿ ğŸ‡¨ğŸ‡¾ Â· Î Î¯ÏƒÏ„Ï‰ÏƒÎ·: Yehonatan Cohen',
        meta: { sector:'Î¤Î¿Î¼Î­Î±Ï‚', aspect:'Î ÏÎ¿ÏƒÎ±Î½Î±Ï„Î¿Î»Î¹ÏƒÎ¼ÏŒÏ‚', tilt:'ÎšÎ»Î¯ÏƒÎ·', baseHorizon:'Î’Î±ÏƒÎ¹ÎºÏŒÏ‚ Î¿ÏÎ¯Î¶Î¿Î½Ï„Î±Ï‚', obstacles:'Î•Î¼Ï€ÏŒÎ´Î¹Î±', date:'Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±', minAlt:'Î•Î». ÎµÎ»Î¬Ï‡Î¹ÏƒÏ„Î¿ ÏÏˆÎ¿Ï‚', azMargin:'Î ÎµÏÎ¹Î¸ÏÏÎ¹Î¿ Î±Î¶Î¹Î¼.' },
  obstaclesNone: 'Î§Ï‰ÏÎ¯Ï‚ ÎµÎ¼Ï€ÏŒÎ´Î¹Î±', obstaclesCount: n => `${n} ÎµÎ¼Ï€ÏŒÎ´Î¹Î±`,
  segmentsSome: 'ÎÏÎµÏ‚ Î®Î»Î¹Î¿Ï…', segmentsNone: 'Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î»Î¹Î¿Ï‚ ÏƒÏ„Î¿ Ï€Î±ÏÎ¬Î¸Ï…ÏÎ¿ 06:00â€“20:00 Î¼Îµ Ï„Î¹Ï‚ Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎµÏ‚ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚.',
  fb: { title:'Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚ / ÏƒÏ‡ÏŒÎ»Î¹Î¿Ï…', name:'ÎŒÎ½Î¿Î¼Î±', email:'Email', msg:'ÎœÎ®Î½Ï…Î¼Î±', send:'Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® (Î¼Î®Î½Ï…Î¼Î±, ÏŒÏ‡Î¹ Î´Î¹Î±Î´ÏÎ¿Î¼Î®) ğŸ™‚', thanks:'Î•Ï…Ï‡Î±ÏÎ¹ÏƒÏ„Î¿ÏÎ¼Îµ! ÎŸ Ï€ÎµÎ»Î¬Ï„Î·Ï‚ email Î¸Î± Î±Î½Î¿Î¯Î¾ÎµÎ¹.' }
      },
      ru: {
        title: 'Ğ¡Ğ¾Ğ»Ğ½Ñ†Ğµ/Ğ¢ĞµĞ½ÑŒ Ğ´Ğ»Ñ ÑĞºĞ°Ğ» Ğ½Ğ° ĞšĞ¸Ğ¿Ñ€Ğµ',
        subtitle: 'ĞŸĞ¾Ğ»ĞµĞ·Ğ½Ñ‹Ğ¹ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚ Ğ´Ğ»Ñ ÑĞºĞ°Ğ»Ğ¾Ğ»Ğ°Ğ·Ğ¾Ğ²',
  labels: { language: 'Ğ¯Ğ·Ñ‹Ğº', sector: 'Ğ¡ĞºĞ°Ğ»Ğ°', date: 'Ğ”Ğ°Ñ‚Ğ°' },
        chartTitle: 'Ğ”Ğ¾Ğ»Ñ Ğ¾ÑĞ²ĞµÑ‰ĞµĞ½Ğ¸Ñ ÑĞ¾Ğ»Ğ½Ñ†ĞµĞ¼ (%) Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸',
        sun: 'Ğ¡Ğ¾Ğ»Ğ½Ñ†Ğµ', shade: 'Ğ¢ĞµĞ½ÑŒ',
        axes: { xTitle: 'Ğ’Ñ€ĞµĞ¼Ñ', yTitle: 'Ğ­ĞºÑĞ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ' },
        nav: { calc: 'ĞšĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€', feedback: 'ĞÑ‚Ğ·Ñ‹Ğ²' },
        credit: 'Ğ¡Ğ´ĞµĞ»Ğ°Ğ½Ğ¾ Ğ´Ğ»Ñ ÑĞºĞ°Ğ»Ğ¾Ğ»Ğ°Ğ·Ğ¾Ğ² ĞšĞ¸Ğ¿Ñ€Ğ° ğŸ‡¨ğŸ‡¾ Â· ĞĞ²Ñ‚Ğ¾Ñ€: Yehonatan Cohen',
        meta: { sector:'Ğ¡ĞµĞºÑ‚Ğ¾Ñ€', aspect:'ĞĞ·Ğ¸Ğ¼ÑƒÑ‚ ÑÑ‚ĞµĞ½Ñ‹', tilt:'ĞĞ°ĞºĞ»Ğ¾Ğ½', baseHorizon:'Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚', obstacles:'ĞŸÑ€ĞµĞ¿ÑÑ‚ÑÑ‚Ğ²Ğ¸Ñ', date:'Ğ”Ğ°Ñ‚Ğ°', minAlt:'ĞœĞ¸Ğ½. Ğ²Ñ‹ÑĞ¾Ñ‚Ğ° ÑĞ¾Ğ»Ğ½Ñ†Ğ°', azMargin:'Ğ”Ğ¾Ğ¿ÑƒÑĞº Ñ„Ñ€Ğ¾Ğ½Ñ‚Ğ°' },
  obstaclesNone: 'Ğ‘ĞµĞ· Ğ¿Ñ€ĞµĞ¿ÑÑ‚ÑÑ‚Ğ²Ğ¸Ğ¹', obstaclesCount: n => `${n} Ğ¿Ñ€ĞµĞ¿ÑÑ‚ÑÑ‚Ğ².`,
  segmentsSome: 'Ğ’Ñ€ĞµĞ¼Ñ ÑĞ¾Ğ»Ğ½Ñ†Ğ°', segmentsNone: 'Ğ¡Ğ¾Ğ»Ğ½Ñ†Ğ° Ğ½ĞµÑ‚ Ğ² Ğ¾ĞºĞ½Ğµ 06:00â€“20:00 Ğ¿Ñ€Ğ¸ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ñ… Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ°Ñ….',
  fb: { title:'ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ / Ğ¾Ñ‚Ğ·Ñ‹Ğ²', name:'Ğ˜Ğ¼Ñ', email:'Email', msg:'Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ', send:'ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ (ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ, Ğ½Ğµ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚) ğŸ™‚', thanks:'Ğ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾! Ğ”Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒÑÑ Ğ¿Ğ¾Ñ‡Ñ‚Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ¸ĞµĞ½Ñ‚.' }
      },
      he: {
        title: '×©××©/×¦×œ ×œ××¦×•×§×™× ×‘×§×¤×¨×™×¡×™×Ÿ',
        subtitle: '×›×œ×™ ×©×™××•×©×™ ×œ××˜×¤×¡×™×',
  labels: { language: '×©×¤×”', sector: '××¦×•×§', date: '×ª××¨×™×š' },
        chartTitle: '×—×©×™×¤×” ×œ×©××© (%) ×œ××•×¨×š ×–××Ÿ',
        sun: '×©××©', shade: '×¦×œ',
        axes: { xTitle: '×©×¢×”', yTitle: '×—×©×™×¤×”' },
        nav: { calc: '××—×©×‘×•×Ÿ', feedback: '×¤×™×“×‘×§' },
        credit: '× ×‘× ×” ×¢×‘×•×¨ ××˜×¤×¡×™× ×‘×§×¤×¨×™×¡×™×Ÿ ğŸ‡¨ğŸ‡¾ Â· ×§×¨×“×™×˜: Yehonatan Cohen',
        meta: { sector:'×¡×§×˜×•×¨', aspect:'×—×–×™×ª', tilt:'×©×™×¤×•×¢', baseHorizon:'××•×¤×§ ×‘×¡×™×¡×™', obstacles:'××›×©×•×œ×™×', date:'×ª××¨×™×š', minAlt:'×’×•×‘×” ×©××© ××™× ×³', azMargin:'×©×•×œ×™ ×—×–×™×ª' },
  obstaclesNone: '××™×Ÿ ××›×©×•×œ×™×', obstaclesCount: n => `${n} ××›×©×•×œ×™×`,
  segmentsSome: '×–×× ×™ ×©××©', segmentsNone: '××™×Ÿ ×©××© ×‘×™×Ÿ 06:00â€“20:00 ×¢× ×”×”×’×“×¨×•×ª ×”× ×•×›×—×™×•×ª.',
  fb: { title:'×©×œ×™×—×ª ×”×•×“×¢×” / ××©×•×‘', name:'×©×', email:'××™××™×™×œ', msg:'×”×•×“×¢×”', send:'×©×œ×— (×”×•×“×¢×”, ×œ× ××¡×œ×•×œ) ğŸ™‚', thanks:'×ª×•×“×”! ××¤×œ×™×§×¦×™×™×ª ×”×“×•×"×œ ×××•×¨×” ×œ×”×™×¤×ª×—.' }
      }
    };
    let CURRENT_LANG = 'en';
    function setLangAttrs(){
      const l = CURRENT_LANG;
      document.documentElement.lang = l;
      document.documentElement.dir = (l==='ar' || l==='he') ? 'rtl' : 'ltr';
    }
    function t(){ return I18N[CURRENT_LANG]; }

    function applyTexts(){
      const tr = t();
      document.querySelector('.brand .title').textContent = tr.title;
      document.querySelector('.brand .subtitle').textContent = `${tr.subtitle} ğŸ§—â€â™€ï¸ğŸ§—â€â™‚ï¸`;
      document.title = tr.title;
      document.getElementById('label-sector').textContent = tr.labels.sector;
      document.getElementById('label-date').textContent = tr.labels.date;
  navCalc.querySelector('.label').textContent = tr.nav.calc;
  navFeedback.querySelector('.label').textContent = tr.nav.feedback;
      creditLine.innerHTML = `${tr.credit} Â· <a id="creditEmail" href="mailto:unique.center.yoni.gmail.com">unique.center.yoni.gmail.com</a> Â· Â© 2025`;
      document.getElementById('fb-title').textContent = tr.fb.title;
      document.getElementById('fb-label-name').textContent = tr.fb.name;
      document.getElementById('fb-label-email').textContent = tr.fb.email;
      document.getElementById('fb-label-msg').textContent = tr.fb.msg;
  document.getElementById('fbSendBtn').textContent = tr.fb.send;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Fit to viewport: set header height CSS var
      const header = document.querySelector('.site-topbar');
      const setHeaderH = () => document.documentElement.style.setProperty('--headerH', `${header?.offsetHeight||0}px`);
      setHeaderH();
      window.addEventListener('resize', setHeaderH);
      try{
        await loadSectors();
      }catch(err){
        console.error('Failed to load sectors.json', err);
      }
      // Build crag groups and populate dropdown with unique crag names
      buildGroups();
      sel.innerHTML = '';
      for(const g of GROUPS){
        const o = document.createElement('option');
        o.value = g.key;
        o.textContent = g.label;
        sel.appendChild(o);
      }
      if(GROUPS.length){
        if(!CRAG_SEL_KEY) CRAG_SEL_KEY = GROUPS[0].key;
        const g = GROUPS.find(x=>x.key===CRAG_SEL_KEY) || GROUPS[0];
        sel.value = g.key;
        if(CURRENT_SECTOR_INDEX < 0 || !g.indices.includes(CURRENT_SECTOR_INDEX)){
          CURRENT_SECTOR_INDEX = g.indices[0];
        }
      }
      const now = new Date();
      dateInp.value = `${now.getFullYear()}-${d2(now.getMonth()+1)}-${d2(now.getDate())}`;
      setLangAttrs();
      applyTexts();
      setLangUI();
  // Show where sectors came from
  // Removed dataStatus line per request (no sector count display)
      // Initial render if we have sectors
      if(SECTORS.length){ calc(); } else { summary.textContent = 'No sectors loaded. Place sectors.json or use the Map editor to create one.'; }
    });
    sel.addEventListener('change', () => {
      CRAG_SEL_KEY = sel.value;
      const g = GROUPS.find(x=>x.key===CRAG_SEL_KEY);
      if(g){
        if(!g.indices.includes(CURRENT_SECTOR_INDEX)){
          CURRENT_SECTOR_INDEX = g.indices[0];
        }
      } else {
        CURRENT_SECTOR_INDEX = -1;
      }
      calc();
    });
    dateInp.addEventListener('change', calc);

    function setView(view){
      const showCalc = view === 'calc';
      calcView.style.display = showCalc ? '' : 'none';
      document.querySelector('.chart-wrap').style.display = showCalc ? '' : 'none';
      feedbackView.style.display = showCalc ? 'none' : '';
      navCalc.classList.toggle('active', showCalc);
      navFeedback.classList.toggle('active', !showCalc);
    }
    navCalc.addEventListener('click', () => setView('calc'));
    navFeedback.addEventListener('click', () => setView('feedback'));

  // No manual JSON loading in calc view; it always fetches sectors.json from the same folder

    function setLangUI(){
      const map = { en:['ğŸ‡¬ğŸ‡§','English'], el:['ğŸ‡¬ğŸ‡·','Î•Î»Î»Î·Î½Î¹ÎºÎ¬'], ru:['ğŸ‡·ğŸ‡º','Ğ ÑƒÑÑĞºĞ¸Ğ¹'], he:['ğŸ‡®ğŸ‡±','×¢×‘×¨×™×ª'] };
      const [ic, nm] = map[CURRENT_LANG] || map.en;
      langIcon.textContent = ic; langName.textContent = nm;
    }
    langBtn.addEventListener('click', () => {
      const open = langMenu.style.display !== 'none';
      langMenu.style.display = open ? 'none' : 'block';
      langBtn.setAttribute('aria-expanded', (!open).toString());
    });
    langMenu.addEventListener('click', (e) => {
      const item = e.target.closest('.lang-item');
      if(!item) return;
      CURRENT_LANG = item.dataset.lang;
      setLangAttrs(); applyTexts(); setLangUI(); calc();
      langMenu.style.display = 'none';
      langBtn.setAttribute('aria-expanded','false');
    });
    document.addEventListener('click', (e) => {
      if(!langMenu.contains(e.target) && !langBtn.contains(e.target)){
        langMenu.style.display='none';
        langBtn.setAttribute('aria-expanded','false');
      }
    });

    function asciiKey(str){
      return (str||'')
        .toLowerCase()
        .replace(/[Î•Îµ]/g,'e') // map Greek epsilon to latin e for stable sorting
        .normalize('NFKD')
        .replace(/[\u0300-\u036f]/g,'');
    }
    function cragKey(s){
      const base = (s.id || s.name || '').toLowerCase();
      if(base.startsWith('pentadaktylos west')) return 'pentadaktylos-west';
      if(base.startsWith('pentadaktylos central')) return 'pentadaktylos-central';
      const m = base.match(/[a-z0-9]+/);
      return m ? m[0] : base;
    }
    function cragLabelFromName(name, key){
      const raw = String(name||'').trim();
      let token = raw.split(/[\-\s]/)[0] || '';
      token = token.trim();
  if(key==='pentadaktylos-west') return 'Pentadaktylos West';
  if(key==='pentadaktylos-central') return 'Pentadaktylos Central';
      if(!token){
        return key ? (key.charAt(0).toUpperCase()+key.slice(1)) : 'Crag';
      }
      if(/^[a-z]+$/.test(token)) return token.charAt(0).toUpperCase()+token.slice(1);
      return token;
    }
    function buildGroups(){
      const map = new Map(); // key -> { key, label, indices }
      for(let i=0;i<SECTORS.length;i++){
        const s = SECTORS[i];
        const key = cragKey(s);
        if(!map.has(key)){
          map.set(key, { key, label: cragLabelFromName(s.name, key), indices: [i] });
        } else {
          map.get(key).indices.push(i);
        }
      }
      GROUPS = Array.from(map.values())
        .sort((a,b) => a.label.toLowerCase().localeCompare(b.label.toLowerCase(), 'en', {sensitivity:'base'}));
      if(!GROUPS.length){ CRAG_SEL_KEY=''; CURRENT_SECTOR_INDEX=-1; return; }
      if(!GROUPS.some(g=>g.key===CRAG_SEL_KEY)){
        CRAG_SEL_KEY = GROUPS[0].key;
      }
      const g = GROUPS.find(x=>x.key===CRAG_SEL_KEY) || GROUPS[0];
      if(!g.indices.includes(CURRENT_SECTOR_INDEX)){
        CURRENT_SECTOR_INDEX = g.indices[0];
      }
    }
  function renderSectorTabs(){
      const norm = s => (s.name||'').toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[Î•Îµ]/g,'e');
      sectorTabs.innerHTML = '';
      if(!SECTORS.length || !CRAG_SEL_KEY){ return; }
      const group = GROUPS.find(g=>g.key===CRAG_SEL_KEY) || GROUPS[0];
      if(!group){ return; }
      const key = group.key;
  sectorTabs.classList.remove('two-lines','west-grid');
      let items = group.indices.map(i => ({ s: SECTORS[i], i }));
      if(!items.length){ return; }
      items.sort((a,b)=> norm(a.s).localeCompare(norm(b.s), 'en', {sensitivity:'base'}));
  // Determine a common prefix pattern to hide (e.g., "Pentadaktylos West - ")
      const rawNames = items.map(o => o.s.name || '');
      let commonPrefix = rawNames[0];
      for(const n of rawNames.slice(1)){
        let j=0; while(j<commonPrefix.length && j<n.length && commonPrefix[j]===n[j]) j++;
        commonPrefix = commonPrefix.slice(0,j);
        if(!commonPrefix) break;
      }
      // Refine: only keep prefix up to last full word and only if contains ' - '
      if(commonPrefix){
        const dashIdx = commonPrefix.lastIndexOf(' - ');
        if(dashIdx!==-1) commonPrefix = commonPrefix.slice(0, dashIdx+3); else commonPrefix='';
      }
  // Explicit overrides for Pentadaktylos groups (ensure full crag prefix removed)
  if(key==='pentadaktylos-west') commonPrefix = 'Pentadaktylos west - ';
  if(key==='pentadaktylos-central') commonPrefix = 'Pentadaktylos central - ';
      // Hue derived from crag key for stable tint
      let hash=0; for(let i=0;i<key.length;i++){ hash = (hash*31 + key.charCodeAt(i))>>>0; }
      const hue = 30 + (hash % 300);
      sectorTabs.style.setProperty('--h', String(hue));
      // Mobile dropdown preparation for pentadaktylos-west
  const mobileCragSelect = document.getElementById('mobileCragSelect');
  if(mobileCragSelect) mobileCragSelect.innerHTML='';
      items.forEach(({s,i}) => {
        const b = document.createElement('button');
        b.className = 'tab' + (i===CURRENT_SECTOR_INDEX?' active':'');
        let label = s.name || '';
        if(commonPrefix){
          const ll = label.toLowerCase();
          const cp = commonPrefix.toLowerCase();
          if(ll.startsWith(cp)) label = label.slice(commonPrefix.length).trim();
        }
        // Trim Diarizous prefix inside tabs
        if(/^diarizous\s+/i.test(label)){
          const rest = label.replace(/^diarizous\s+/i,'');
          if(rest.length>0) label = rest;
        }
        if(!label) label = s.name || '(unnamed)';
        // Capitalize first letter
        if(label && label.length){
          label = label.charAt(0).toUpperCase() + label.slice(1);
        }
        b.textContent = label;
        b.addEventListener('click', () => {
          CURRENT_SECTOR_INDEX = i;
          if(sel.value !== key) sel.value = key; // keep dropdown synced
          calc();
        });
        sectorTabs.appendChild(b);
        // Populate mobile select for west
        if(mobileCragSelect){
          const opt=document.createElement('option');
          opt.value=String(i); opt.textContent=label; if(i===CURRENT_SECTOR_INDEX) opt.selected=true; mobileCragSelect.appendChild(opt);
        }
      });
      // Multi-sector layout & mobile dropdown if more than 3 sectors
      const isMulti = items.length > 3;
      if(isMulti) sectorTabs.classList.add('multi-grid');
      if(isMulti){
        const wrap = document.getElementById('mobileCragSelectWrap');
        if(wrap){
          if(window.matchMedia('(max-width:640px)').matches){
            sectorTabs.classList.add('mobile-hidden');
            wrap.style.display='block';
            if(mobileCragSelect){
              mobileCragSelect.onchange = e => { CURRENT_SECTOR_INDEX = +e.target.value; calc(); };
            }
          } else {
            sectorTabs.classList.remove('mobile-hidden');
            wrap.style.display='none';
          }
        }
      }
    }

    // ---------- Chart ----------
  let chart;
  let CLIMBER_MARK = null; // { xIndex }
    const ctx = document.getElementById('chart').getContext('2d');
    function renderChart(labels, exposurePct){
      if(chart) chart.destroy();
    const climberPlugin = {
        id: 'climberMark',
        afterDraw(c){
          if(!CLIMBER_MARK) return;
          const idx = CLIMBER_MARK.xIndex;
          if(idx==null) return;
          const meta = c.getDatasetMeta(0);
          if(!meta || !meta.data || !meta.data[idx]) return;
          const pt = meta.data[idx];
          const ctx = c.ctx;
          ctx.save();
          const emoji = 'ğŸ§—';
      const area = c.chartArea;
      const x = pt.x;
      // Center vertically in plot area
      const y = (area.top + area.bottom) / 2;
      // Adaptive size: up to 60px or 30% of plot height
      const size = Math.min(60, Math.max(28, Math.floor((area.bottom-area.top)*0.30)));
      ctx.font = size + 'px system-ui, sans-serif';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.shadowColor = 'rgba(0,0,0,0.25)';
          ctx.shadowBlur = 4; ctx.shadowOffsetY = 2;
          ctx.fillText(emoji, x, y);
          ctx.restore();
        }
      };
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: t().sun,
            data: exposurePct,
            borderColor: '#FFD400',
            backgroundColor: 'rgba(255,212,0,0.18)',
            fill: true,
            tension: 0.25,
            pointRadius: 0,
            borderWidth: 3
          }]
        },
        options: {
          responsive:true, maintainAspectRatio:false,
          scales:{
            x:{ title:{display:true, text:t().axes.xTitle, font:{size:13}}, ticks:{font:{size:12}} },
            y:{ beginAtZero:true, max:100, title:{display:true, text:t().axes.yTitle, font:{size:13}}, ticks:{callback:v=>v+'%', font:{size:12}} }
          },
          plugins:{
            legend:{display:false},
            tooltip:{callbacks:{ label: c => `${t().sun}: ${c.parsed.y.toFixed(0)}%` }, titleFont:{size:13}, bodyFont:{size:12}},
            title:{display:true,text:t().chartTitle, font:{size:14}}
          }
        },
        plugins:[climberPlugin]
      });
    }

    // ---------- ×—×™×©×•×‘ (×—×©×™×¤×” ××“×•×¨×’×ª ×©××’×™×¢×” ×œ-100%) ----------
    function calc(){
      if(!SECTORS.length || CURRENT_SECTOR_INDEX<0){
        if(chart) { chart.destroy(); chart = null; }
        sectorTabs.innerHTML = '';
        summary.textContent = 'No sectors loaded.';
        return;
      }
      if(CRAG_SEL_KEY){
        const g = GROUPS.find(x=>x.key===CRAG_SEL_KEY);
        if(g && !g.indices.includes(CURRENT_SECTOR_INDEX)){
          CURRENT_SECTOR_INDEX = g.indices[0];
        }
      }
      const s = SECTORS[CURRENT_SECTOR_INDEX];
      renderSectorTabs();
      const dateStr = dateInp.value;

  const minAltInput = (typeof s.defaults.minAlt === 'number') ? s.defaults.minAlt : 3; // ×’×•×‘×” ××™× ×™××œ×™ ×‘×¡×™×¡×™
  const margin = (typeof s.defaults.margin === 'number') ? s.defaults.margin : 0; // ×œ×©×™××•×© ×‘×ª×¦×•×’×ª ××˜× ×‘×œ×‘×“
  const TRANSITION_ALT_DEG = 3; // ××¢×‘×¨ ×—×œ×§ ×œ×¤×™ ×’×•×‘×” ×”×©××© (Â°)
  const DOT_BAND_DEG = 5; // ××¢×‘×¨ ×—×œ×§ ×¡×‘×™×‘ ×¡×£ ×¤× ×™×” (××¢×œ×•×ª ××–×•×•×™×ª ××©×™×§×”)

      // smoothstep 0..1
      function smoothstep01(x){
        const xx = Math.max(0, Math.min(1, x));
        return xx*xx*(3 - 2*xx);
      }

  const startH=6, endH=21, stepMin=5;
      const labels = []; const exposure=[]; const litIntervals=[];
      const base = new Date(dateStr + 'T00:00:00');

      // ×ª×•×•×™×•×ª ×›×œ 5 ×“×§×•×ª
      for(let h=startH; h<=endH; h++){
        for(let m=0; m<60; m+=stepMin){
          labels.push(`${d2(h)}:${d2(m)}`);
        }
      }

      // × ×•×¨××œ ×§×‘×•×¢ ×œ×¡×§×˜×•×¨ (× ×©××¨ ×›××• ×‘×§×•×“ ×©×œ×š)
      const N = normalVector(s.aspect, s.tilt);

      let lastLit=false, segStart=null;
      for(let h=startH; h<=endH; h++){
        for(let m=0; m<60; m+=stepMin){
          const tNow = new Date(base.getFullYear(), base.getMonth(), base.getDate(), h, m, 0);
          const pos = SunCalc.getPosition(tNow, s.lat, s.lon);
          const az = azimuthDeg(pos);
          const alt = altitudeDeg(pos);

          // ×¡×£ ×’×•×‘×”: ××§×¡' ××‘×™×Ÿ ××™× ' ×¡×§×˜×•×¨, ××•×¤×§ ×‘×¡×™×¡×™, ×•××›×©×•×œ ×‘×›×™×•×•×Ÿ ×”×©××©
          const obsAlt = obstacleAltForAz(az, s.obstaclesAbs);
          const requiredAlt = Math.max(
            0,
            minAltInput,
            s.defaults.horizon || 0,
            (obsAlt==null ? -Infinity : obsAlt)
          );

          // ×•×§×˜×•×¨ ×”×©××© ×•×©×¢×¨ "×¤×•× ×” ×œ×©××©" (××¢×‘×¨ ×—×œ×§ ×¡×‘×™×‘ dotâ‰ˆ0)
          const S = sunVector(az, alt);
          const dot = dot3(N, S);
          const dotBand = Math.sin(toRad(DOT_BAND_DEG)); // ~0.087 ×œ-5Â°
          const facingFactor = smoothstep01((dot - 0) / (dotBand || 1));

          // ×’×•×¨× ×’×•×‘×” ×—×œ×§ ×¡×‘×™×‘ requiredAlt
          const altFactor = smoothstep01((alt - requiredAlt) / TRANSITION_ALT_DEG);

          // ×—×©×™×¤×” ×¡×•×¤×™×ª: ××›×¤×œ×ª ×©×¢×¨×™× ×—×œ×§×™× â†’ 1 ×‘×¤× ×™×, 0 ×‘×©×•×œ×™×™×/×¦×œ
          const f = Math.max(0, Math.min(1, facingFactor * altFactor));
          exposure.push(100 * f);

          const isLit = f > 0;
          if(isLit && !lastLit) segStart=tNow;
          if(!isLit && lastLit){ litIntervals.push([segStart, new Date(tNow.getTime()-stepMin*60000)]); segStart=null; }
          lastLit = isLit;
        }
      }
      if(lastLit && segStart){
        const tEnd = new Date(base.getFullYear(), base.getMonth(), base.getDate(), endH, 59, 59);
        litIntervals.push([segStart, tEnd]);
      }

      // Trim chart strictly to astronomical sunset for the date/sector
      const times = SunCalc.getTimes(new Date(dateStr + 'T12:00:00'), s.lat, s.lon);
      const sunset = times && times.sunset ? times.sunset : null;
      let finalLen;
      if(sunset){
        const sunsetMin = sunset.getHours()*60 + sunset.getMinutes();
        const startMin = startH*60;
        const stepsFromStart = Math.max(1, Math.floor((sunsetMin - startMin)/stepMin) + 1);
        finalLen = Math.min(exposure.length, stepsFromStart);
      } else {
        finalLen = exposure.length;
      }
      labels.length = finalLen;
      exposure.length = finalLen;

      // ---- Compute central zero-exposure segment for climber mark ----
      (function computeClimber(){
        CLIMBER_MARK = null;
        if(!exposure.length) return;
        const zeros = [];// {start,end}
        let start=null;
        for(let i=0;i<exposure.length;i++){
          if(exposure[i] < 0.5){ if(start==null) start=i; }
          else if(start!=null){ zeros.push({start,end:i-1}); start=null; }
        }
        if(start!=null) zeros.push({start,end:exposure.length-1});
        if(!zeros.length) return;
        const midAll = (exposure.length-1)/2;
        let best=null, bestDist=Infinity;
        zeros.forEach(z=>{ const mid = (z.start+z.end)/2; const dist = Math.abs(mid-midAll); if(dist<bestDist){ bestDist=dist; best={mid, z}; } });
        if(best) CLIMBER_MARK = { xIndex: Math.round(best.mid) };
      })();
      renderChart(labels, exposure);

      // ××˜×
      const tr = t();
      const tiltTxt = `${s.tilt>0?'+':''}${s.tilt}Â°`;
      const obsTxt = s.obstaclesAbs?.length ? (typeof tr.obstaclesCount==='function'? tr.obstaclesCount(s.obstaclesAbs.length): `${s.obstaclesAbs.length}`) : tr.obstaclesNone;
      meta.innerHTML = `
        <span class="pill">${tr.meta.sector}: <b>${s.name}</b></span>
        <span class="pill">${tr.meta.aspect}: ${Math.round(s.aspect)}Â°</span>
        <span class="pill">${tr.meta.tilt}: ${tiltTxt}</span>
        <span class="pill">${tr.meta.baseHorizon}: ${s.defaults.horizon}Â°</span>
        <span class="pill">${tr.meta.obstacles}: ${obsTxt}</span>
        <span class="pill">${tr.meta.date}: ${new Date(dateStr).toLocaleDateString(CURRENT_LANG==='ru'?'ru-RU':CURRENT_LANG==='el'?'el-GR':'en-GB')}</span>
        <span class="pill">${tr.meta.minAlt}: ${minAltInput}Â°</span>
        <span class="pill">${tr.meta.azMargin}: ${margin}Â°</span>
      `;

      summary.textContent = litIntervals.length
        ? `${t().segmentsSome}: ${litIntervals.map(([a,b]) => `${a.getHours().toString().padStart(2,'0')}:${a.getMinutes().toString().padStart(2,'0')}â€“${b.getHours().toString().padStart(2,'0')}:${b.getMinutes().toString().padStart(2,'0')}`).join(' , ')}`
        : t().segmentsNone;
    }

    // Feedback send
    const FB_EMAIL = 'unique.center.yoni.gmail.com';
    document.getElementById('fbSendBtn').addEventListener('click', () => {
      const name = (document.getElementById('fbName').value||'').trim();
      const email = (document.getElementById('fbEmail').value||'').trim();
      const msg = (document.getElementById('fbMsg').value||'').trim();
      const subject = encodeURIComponent(`[Cyprus Crags] Feedback from ${name||'anonymous'}`);
      const body = encodeURIComponent(`Name: ${name}\nEmail: ${email}\n\nMessage:\n${msg}`);
      const link = `mailto:${FB_EMAIL}?subject=${subject}&body=${body}`;
      window.location.href = link;
      document.getElementById('fbStatus').textContent = t().fb.thanks;
    });

    window.addEventListener('load', () => { setView('calc'); calc(); });
  </script>
</body>
</html>
